<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Reino da Barba</title>
    <!-- SheetJS (xlsx) for Excel/CSV parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for charting -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Chart.js Datalabels Plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <style>
        :root {
            --bg-color: #f8fafc;
            --text-color: #1e293b;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --primary-color: #1e3a8a; /* Dark Blue */
            --secondary-color: #10b981; /* Green */
            --accent-color: #f97316; /* Orange */
            --shadow-color: rgba(0, 0, 0, 0.05);
            --chart-grid-color: #e2e8f0;
            --chart-text-color: #475569;
        }

        body.dark-mode {
            --bg-color: #1e293b;
            --text-color: #f8fafc;
            --card-bg: #334155;
            --border-color: #475569;
            --primary-color: #60a5fa; /* Light Blue */
            --secondary-color: #34d399; /* Lighter Green */
            --accent-color: #fb923c; /* Lighter Orange */
            --shadow-color: rgba(0, 0, 0, 0.3);
            --chart-grid-color: #475569;
            --chart-text-color: #cbd5e1;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background-color: var(--card-bg);
            padding: 1rem 2rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-color);
            z-index: 1000;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 1.8rem;
        }

        .theme-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color);
            transition: color 0.3s;
        }

        .theme-toggle:hover {
            color: var(--primary-color);
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 280px 1fr;
            flex-grow: 1;
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .sidebar {
            background-color: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 4px 8px var(--shadow-color);
            overflow-y: auto;
            max-height: calc(100vh - 120px); /* Adjust based on header height */
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .sidebar h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .filter-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 4px;
            background-color: var(--bg-color);
        }

        .filter-options label {
            font-weight: normal;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            cursor: pointer;
            color: var(--text-color);
        }

        .filter-options input[type="checkbox"] {
            accent-color: var(--primary-color);
        }

        .filter-group select,
        .filter-group input[type="date"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin-top: 0.5rem;
        }

        .filter-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .filter-actions button {
            flex: 1;
            padding: 0.7rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, color 0.2s;
        }

        .filter-actions .apply-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .filter-actions .apply-btn:hover {
            background-color: #1a2e6b;
        }

        .filter-actions .clear-btn {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        .filter-actions .clear-btn:hover {
            background-color: #cbd5e1;
        }

        .active-filters-count {
            font-size: 0.9rem;
            color: var(--accent-color);
            margin-top: 0.5rem;
            text-align: center;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .file-import-section {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .file-import-section input[type="file"] {
            display: none;
        }

        .file-import-section label {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }

        .file-import-section label:hover {
            background-color: #0d9488;
        }

        .file-import-message {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .error-message {
            color: #ef4444;
            font-weight: bold;
            margin-top: 0.5rem;
            text-align: center;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .tab-button {
            background-color: var(--card-bg);
            color: var(--text-color);
            padding: 0.8rem 1.5rem;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s;
        }

        .tab-button:hover {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        .tab-button.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            background-color: var(--bg-color);
        }

        .tab-content {
            display: none;
            flex-direction: column;
            gap: 1.5rem;
        }

        .tab-content.active {
            display: flex;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .kpi-card {
            background-color: var(--card-bg);
            padding: 1.2rem;
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 0.5rem;
            transition: transform 0.2s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-card .icon {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .kpi-card .label {
            font-size: 0.9rem;
            color: var(--chart-text-color);
            font-weight: 600;
        }

        .kpi-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-color);
        }

        .kpi-card .change {
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.2rem;
        }

        .kpi-card .change.positive {
            color: var(--secondary-color);
        }

        .kpi-card .change.negative {
            color: #ef4444;
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .chart-container {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            min-height: 350px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .chart-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s;
        }

        .loading-overlay.visible {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .instructions {
            background-color: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 8px var(--shadow-color);
            margin-top: 1.5rem;
        }

        .instructions h3 {
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .instructions ul {
            list-style-type: disc;
            margin-left: 1.5rem;
            color: var(--text-color);
        }

        .instructions li {
            margin-bottom: 0.5rem;
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            .sidebar {
                max-height: none;
                overflow-y: visible;
            }
            .chart-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 0.5rem;
            }
            .header h1 {
                font-size: 1.5rem;
            }
            .dashboard-container {
                padding: 1rem;
                gap: 1rem;
            }
            .sidebar, .file-import-section, .chart-container, .kpi-card, .instructions {
                padding: 1rem;
            }
            .tabs {
                flex-wrap: wrap;
            }
            .tab-button {
                flex: 1 1 auto;
                padding: 0.6rem 1rem;
                font-size: 0.9rem;
            }
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .kpi-card .value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header class="header">
        <h1>Dashboard Reino da Barba</h1>
        <button id="themeToggle" class="theme-toggle">‚òÄÔ∏è</button>
    </header>

    <div class="dashboard-container">
        <aside class="sidebar">
            <h3>Importar Dados</h3>
            <div class="file-import-section">
                <input type="file" id="fileInput" accept=".xlsx, .xls, .csv">
                <label for="fileInput">Carregar Arquivo Excel/CSV</label>
                <div id="fileImportMessage" class="file-import-message">Nenhum arquivo carregado.</div>
                <div id="errorMessage" class="error-message"></div>
            </div>

            <h3>Filtros</h3>
            <div class="filter-group">
                <label>Ano:</label>
                <div id="yearFilterOptions" class="filter-options"></div>
            </div>
            <div class="filter-group">
                <label>M√™s:</label>
                <div id="monthFilterOptions" class="filter-options"></div>
            </div>
            <div class="filter-group">
                <label for="quinzenaFilter">Quinzena:</label>
                <select id="quinzenaFilter">
                    <option value="Todas">Todas</option>
                    <option value="1¬™">1¬™ Quinzena</option>
                    <option value="2¬™">2¬™ Quinzena</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Dia da Semana:</label>
                <div id="dayOfWeekFilterOptions" class="filter-options"></div>
            </div>
            <div class="filter-group">
                <label>Tipo de Servi√ßo:</label>
                <div id="serviceTypeFilterOptions" class="filter-options"></div>
            </div>
            <div class="filter-group">
                <label>Forma de Pagamento:</label>
                <div id="paymentMethodFilterOptions" class="filter-options"></div>
            </div>
            <div class="filter-group">
                <label>Per√≠odo Personalizado:</label>
                <input type="date" id="startDateFilter">
                <input type="date" id="endDateFilter">
            </div>
            <div class="filter-actions">
                <button class="apply-btn" id="applyFiltersBtn">Aplicar Filtros</button>
                <button class="clear-btn" id="clearFiltersBtn">Limpar Filtros</button>
            </div>
            <div id="activeFiltersCount" class="active-filters-count">0 filtros ativos</div>
        </aside>

        <main class="main-content">
            <div class="tabs">
                <button class="tab-button active" data-tab="executiva">Vis√£o Executiva</button>
                <button class="tab-button" data-tab="operacional">An√°lise Operacional</button>
                <button class="tab-button" data-tab="clientes">An√°lise de Clientes</button>
                <button class="tab-button" data-tab="financeira">An√°lise Financeira</button>
            </div>

            <div id="executiva" class="tab-content active">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <span class="icon">üí∞</span>
                        <div class="label">Faturamento Total</div>
                        <div class="value" id="kpiTotalRevenue">R$ 0,00</div>
                        <div class="change" id="kpiRevenueChange"></div>
                    </div>
                    <div class="kpi-card">
                        <span class="icon">üí∏</span>
                        <div class="label">Ticket M√©dio</div>
                        <div class="value" id="kpiAverageTicket">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <span class="icon">üë•</span>
                        <div class="label">Clientes Atendidos</div>
                        <div class="value" id="kpiTotalClients">0</div>
                    </div>
                    <div class="kpi-card">
                        <span class="icon">üéØ</span>
                        <div class="label">Atingimento da Meta</div>
                        <div class="value" id="kpiGoalAchievement">0%</div>
                    </div>
                    <div class="kpi-card">
                        <span class="icon">üë®‚Äçüíº</span>
                        <div class="label">Comiss√£o Jean</div>
                        <div class="value" id="kpiJeanCommission">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <span class="icon">üíà</span>
                        <div class="label">Comiss√£o Reino da Barba</div>
                        <div class="value" id="kpiReinoCommission">R$ 0,00</div>
                    </div>
                    <div class="kpi-card">
                        <span class="icon">üìà</span>
                        <div class="label">Crescimento MoM</div>
                        <div class="value" id="kpiMoMGrowth">0%</div>
                    </div>
                    <div class="kpi-card">
                        <span class="icon">üóìÔ∏è</span>
                        <div class="label">Servi√ßos/Dia (M√©dia)</div>
                        <div class="value" id="kpiAvgServicesPerDay">0</div>
                    </div>
                </div>
                <div class="chart-grid">
                    <div class="chart-container"><canvas id="monthlyRevenueChart"></canvas></div>
                    <div class="chart-container"><canvas id="goalAchievementChart"></canvas></div>
                    <div class="chart-container"><canvas id="serviceMixChart"></canvas></div>
                    <div class="chart-container"><canvas id="top5ClientsChart"></canvas></div>
                </div>
            </div>

            <div id="operacional" class="tab-content">
                <div class="chart-grid">
                    <div class="chart-container"><canvas id="revenueByDayOfWeekChart"></canvas></div>
                    <div class="chart-container"><canvas id="dailyProductivityChart"></canvas></div>
                    <div class="chart-container"><canvas id="servicesHeatmapChart"></canvas></div>
                    <div class="chart-container"><canvas id="paymentMethodsChart"></canvas></div>
                    <div class="chart-container"><canvas id="avgTicketByServiceChart"></canvas></div>
                    <div class="chart-container"><canvas id="revenueByFortnightChart"></canvas></div>
                </div>
            </div>

            <div id="clientes" class="tab-content">
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <span class="icon">üîÑ</span>
                        <div class="label">Taxa de Reten√ß√£o</div>
                        <div class="value" id="kpiRetentionRate">0%</div>
                    </div>
                </div>
                <div class="chart-grid">
                    <div class="chart-container"><canvas id="top10ClientsChart"></canvas></div>
                    <div class="chart-container"><canvas id="clientFrequencyChart"></canvas></div>
                    <div class="chart-container"><canvas id="newRecurringClientsChart"></canvas></div>
                    <div class="chart-container"><canvas id="paretoChart"></canvas></div>
                </div>
            </div>

            <div id="financeira" class="tab-content">
                <div class="chart-grid">
                    <div class="chart-container"><canvas id="paymentMethodsEvolutionChart"></canvas></div>
                    <div class="chart-container"><canvas id="commissionDistributionChart"></canvas></div>
                    <div class="chart-container"><canvas id="goalGapWaterfallChart"></canvas></div>
                    <div class="chart-container"><canvas id="seasonalityChart"></canvas></div>
                    <div class="chart-container"><canvas id="yoyComparisonChart"></canvas></div>
                </div>
            </div>

            <div class="instructions">
                <h3>Instru√ß√µes de Uso</h3>
                <ul>
                    <li><strong>1. Carregar Arquivo:</strong> Clique em "Carregar Arquivo Excel/CSV" e selecione sua base de dados. O arquivo deve conter as seguintes colunas: `Ano`, `M√™s`, `Dia`, `Dia da Semana`, `Quinzena`, `Nome`, `Tipo de Servi√ßo`, `Valor`, `Forma de Pagamento`, `Comiss√£o Jean`, `Comiss√£o Reino da Barba`, `Meta Mensal`, `Meta de Clientes`.</li>
                    <li><strong>2. Aplicar Filtros:</strong> Use os filtros na barra lateral para refinar os dados. Selecione anos, meses, dias da semana, tipos de servi√ßo, formas de pagamento ou um per√≠odo personalizado. Clique em "Aplicar Filtros" para atualizar o dashboard.</li>
                    <li><strong>3. Navegar entre Abas:</strong> Utilize as abas (Vis√£o Executiva, An√°lise Operacional, etc.) para explorar diferentes aspectos do neg√≥cio.</li>
                    <li><strong>4. Modo Escuro/Claro:</strong> Clique no √≠cone de sol/lua no cabe√ßalho para alternar entre os modos de visualiza√ß√£o.</li>
                    <li><strong>5. Interatividade:</strong> Passe o mouse sobre os gr√°ficos para ver detalhes nos tooltips.</li>
                </ul>
            </div>
        </main>
    </div>

    <script>
        Chart.register(ChartDataLabels); // Register the datalabels plugin

        let rawData = [];
        let filteredData = [];
        let goalsData = {}; // Stores monthly goals from rawData
        let charts = {}; // Object to hold all Chart.js instances
        let currentTheme = localStorage.getItem('theme') || 'light';
        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];
        const fullMonthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const dayOfWeekNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];
        const fullDayOfWeekNames = ["Domingo", "Segunda-feira", "Ter√ßa-feira", "Quarta-feira", "Quinta-feira", "Sexta-feira", "S√°bado"];

        const requiredColumns = [
            "Ano", "M√™s", "Dia", "Dia da Semana", "Quinzena", "Nome", "Tipo de Servi√ßo",
            "Valor", "Forma de Pagamento", "Comiss√£o Jean", "Comiss√£o Reino da Barba",
            "Meta Mensal", "Meta de Clientes"
        ];

        // --- Utility Functions ---
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function formatPercentage(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'percent', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(value / 100);
        }

        function getMonthName(monthIndex) {
            return monthNames[monthIndex - 1]; // M√™s is 1-indexed
        }

        function getFullMonthName(monthIndex) {
            return fullMonthNames[monthIndex - 1];
        }

        function getWeekDayName(dayIndex) {
            return dayOfWeekNames[dayIndex]; // Dia da Semana is 0-indexed (Sunday=0)
        }

        function getFullWeekDayName(dayIndex) {
            return fullDayOfWeekNames[dayIndex];
        }

        function parseDate(year, month, day) {
            // Ensure month is 1-indexed for Date constructor
            return new Date(year, month - 1, day);
        }

        function calculateMoMChange(current, previous) {
            if (previous === 0) return current > 0 ? 100 : 0; // Infinite growth if prev was 0 and current > 0
            return ((current - previous) / previous) * 100;
        }

        function showLoadingSpinner() {
            document.getElementById('loadingOverlay').classList.add('visible');
        }

        function hideLoadingSpinner() {
            document.getElementById('loadingOverlay').classList.remove('visible');
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function clearError() {
            document.getElementById('errorMessage').textContent = '';
            document.getElementById('errorMessage').style.display = 'none';
        }

        function destroyCharts() {
            for (const chartId in charts) {
                if (charts[chartId]) {
                    charts[chartId].destroy();
                    charts[chartId] = null;
                }
            }
        }

        function getChartColors(index) {
            const colors = [
                '#1e3a8a', '#10b981', '#f97316', '#ef4444', '#6366f1', '#06b6d4', '#f59e0b', '#8b5cf6',
                '#be123c', '#059669', '#db2777', '#7c3aed', '#ca8a04', '#dc2626', '#2563eb', '#ea580c'
            ];
            return colors[index % colors.length];
        }

        function getChartBorderColors(index) {
            const colors = [
                '#172b6b', '#0c8a61', '#d45e0f', '#c23333', '#4f52cc', '#048a9f', '#c47c08', '#6d42d0',
                '#9e0f2c', '#03704f', '#b31f60', '#612dbd', '#a36d03', '#b31f1f', '#1d4ed8', '#c2410c'
            ];
            return colors[index % colors.length];
        }

        // --- Theme Toggle ---
        function applyTheme(theme) {
            document.body.classList.toggle('dark-mode', theme === 'dark');
            document.getElementById('themeToggle').textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
            localStorage.setItem('theme', theme);
            currentTheme = theme;
            // Re-render charts to apply new theme colors
            if (rawData.length > 0) {
                renderDashboard();
            }
        }

        document.getElementById('themeToggle').addEventListener('click', () => {
            applyTheme(currentTheme === 'light' ? 'dark' : 'light');
        });

        // Initial theme application
        applyTheme(currentTheme);

        // --- Data Processing ---
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            showLoadingSpinner();
            clearError();
            document.getElementById('fileImportMessage').textContent = `Carregando ${file.name}...`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(worksheet);

                    if (json.length === 0) {
                        throw new Error("O arquivo est√° vazio ou n√£o cont√©m dados v√°lidos.");
                    }

                    // Validate columns
                    const actualColumns = Object.keys(json[0]);
                    const missingColumns = requiredColumns.filter(col => !actualColumns.includes(col));
                    if (missingColumns.length > 0) {
                        throw new Error(`Colunas obrigat√≥rias ausentes: ${missingColumns.join(', ')}. Verifique o cabe√ßalho do seu arquivo.`);
                    }

                    rawData = json.map(row => {
                        // Ensure numeric values are parsed correctly
                        row.Valor = parseFloat(String(row.Valor).replace(',', '.')) || 0;
                        row['Comiss√£o Jean'] = parseFloat(String(row['Comiss√£o Jean']).replace(',', '.')) || 0;
                        row['Comiss√£o Reino da Barba'] = parseFloat(String(row['Comiss√£o Reino da Barba']).replace(',', '.')) || 0;
                        row['Meta Mensal'] = parseFloat(String(row['Meta Mensal']).replace(',', '.')) || 0;
                        row['Meta de Clientes'] = parseInt(row['Meta de Clientes']) || 0;
                        row.Ano = parseInt(row.Ano) || 0;
                        row.M√™s = parseInt(row.M√™s) || 0;
                        row.Dia = parseInt(row.Dia) || 0;

                        // Add a full date object for easier filtering
                        row.FullDate = parseDate(row.Ano, row.M√™s, row.Dia);
                        return row;
                    });

                    // Extract goals data
                    goalsData = {};
                    rawData.forEach(row => {
                        const key = `${row.Ano}-${row.M√™s}`;
                        if (!goalsData[key]) {
                            goalsData[key] = {
                                metaMensal: row['Meta Mensal'],
                                metaClientes: row['Meta de Clientes']
                            };
                        }
                    });

                    document.getElementById('fileImportMessage').textContent = `Arquivo "${file.name}" carregado com sucesso! ${rawData.length} registros encontrados.`;
                    populateFilterOptions();
                    applyFilters(); // Initial render with all data
                } catch (error) {
                    showError(`Erro ao processar arquivo: ${error.message}`);
                    document.getElementById('fileImportMessage').textContent = `Falha ao carregar arquivo.`;
                    rawData = []; // Clear data on error
                } finally {
                    hideLoadingSpinner();
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function populateFilterOptions() {
            if (rawData.length === 0) return;

            const years = [...new Set(rawData.map(d => d.Ano))].sort((a, b) => a - b);
            const months = [...new Set(rawData.map(d => d.M√™s))].sort((a, b) => a - b);
            const daysOfWeek = [...new Set(rawData.map(d => d['Dia da Semana']))].sort((a, b) => a - b);
            const serviceTypes = [...new Set(rawData.map(d => d['Tipo de Servi√ßo']))].sort();
            const paymentMethods = [...new Set(rawData.map(d => d['Forma de Pagamento']))].sort();

            const createCheckboxes = (containerId, options, valueMapper, labelMapper) => {
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                options.forEach(option => {
                    const id = `filter-${containerId}-${valueMapper(option)}`;
                    container.innerHTML += `
                        <label for="${id}">
                            <input type="checkbox" id="${id}" value="${valueMapper(option)}" checked>
                            ${labelMapper(option)}
                        </label>
                    `;
                });
            };

            createCheckboxes('yearFilterOptions', years, y => y, y => y);
            createCheckboxes('monthFilterOptions', months, m => m, m => getFullMonthName(m));
            createCheckboxes('dayOfWeekFilterOptions', daysOfWeek, d => d, d => getFullWeekDayName(d));
            createCheckboxes('serviceTypeFilterOptions', serviceTypes, s => s, s => s);
            createCheckboxes('paymentMethodFilterOptions', paymentMethods, p => p, p => p);

            // Set default date range to cover all data
            const minDate = new Date(Math.min(...rawData.map(d => d.FullDate.getTime())));
            const maxDate = new Date(Math.max(...rawData.map(d => d.FullDate.getTime())));
            document.getElementById('startDateFilter').value = minDate.toISOString().split('T')[0];
            document.getElementById('endDateFilter').value = maxDate.toISOString().split('T')[0];
        }

        function getSelectedFilters() {
            const getCheckedValues = (containerId) => {
                return Array.from(document.querySelectorAll(`#${containerId} input[type="checkbox"]:checked`)).map(cb => cb.value);
            };

            const selectedYears = getCheckedValues('yearFilterOptions').map(Number);
            const selectedMonths = getCheckedValues('monthFilterOptions').map(Number);
            const selectedDaysOfWeek = getCheckedValues('dayOfWeekFilterOptions').map(Number);
            const selectedServiceTypes = getCheckedValues('serviceTypeFilterOptions');
            const selectedPaymentMethods = getCheckedValues('paymentMethodFilterOptions');
            const selectedQuinzena = document.getElementById('quinzenaFilter').value;
            const startDate = document.getElementById('startDateFilter').value ? new Date(document.getElementById('startDateFilter').value + 'T00:00:00') : null;
            const endDate = document.getElementById('endDateFilter').value ? new Date(document.getElementById('endDateFilter'].value + 'T23:59:59') : null;

            let activeFiltersCount = 0;
            if (selectedYears.length > 0 && selectedYears.length < document.querySelectorAll('#yearFilterOptions input').length) activeFiltersCount++;
            if (selectedMonths.length > 0 && selectedMonths.length < document.querySelectorAll('#monthFilterOptions input').length) activeFiltersCount++;
            if (selectedDaysOfWeek.length > 0 && selectedDaysOfWeek.length < document.querySelectorAll('#dayOfWeekFilterOptions input').length) activeFiltersCount++;
            if (selectedServiceTypes.length > 0 && selectedServiceTypes.length < document.querySelectorAll('#serviceTypeFilterOptions input').length) activeFiltersCount++;
            if (selectedPaymentMethods.length > 0 && selectedPaymentMethods.length < document.querySelectorAll('#paymentMethodFilterOptions input').length) activeFiltersCount++;
            if (selectedQuinzena !== 'Todas') activeFiltersCount++;
            if (startDate || endDate) activeFiltersCount++;

            document.getElementById('activeFiltersCount').textContent = `${activeFiltersCount} filtro(s) ativo(s)`;

            return {
                selectedYears,
                selectedMonths,
                selectedDaysOfWeek,
                selectedServiceTypes,
                selectedPaymentMethods,
                selectedQuinzena,
                startDate,
                endDate
            };
        }

        function applyFilters() {
            if (rawData.length === 0) {
                filteredData = [];
                renderDashboard();
                return;
            }

            showLoadingSpinner();
            const filters = getSelectedFilters();

            filteredData = rawData.filter(row => {
                const rowDate = row.FullDate;
                const rowQuinzena = row.Dia <= 15 ? '1¬™' : '2¬™';

                return (filters.selectedYears.includes(row.Ano)) &&
                       (filters.selectedMonths.includes(row.M√™s)) &&
                       (filters.selectedDaysOfWeek.includes(row['Dia da Semana'])) &&
                       (filters.selectedServiceTypes.includes(row['Tipo de Servi√ßo'])) &&
                       (filters.selectedPaymentMethods.includes(row['Forma de Pagamento'])) &&
                       (filters.selectedQuinzena === 'Todas' || rowQuinzena === filters.selectedQuinzena) &&
                       (!filters.startDate || rowDate >= filters.startDate) &&
                       (!filters.endDate || rowDate <= filters.endDate);
            });

            renderDashboard();
            hideLoadingSpinner();
        }

        function clearFilters() {
            // Uncheck all checkboxes
            document.querySelectorAll('.filter-options input[type="checkbox"]').forEach(cb => cb.checked = true);
            // Reset dropdowns
            document.getElementById('quinzenaFilter').value = 'Todas';
            // Reset date pickers to cover all data
            if (rawData.length > 0) {
                const minDate = new Date(Math.min(...rawData.map(d => d.FullDate.getTime())));
                const maxDate = new Date(Math.max(...rawData.map(d => d.FullDate.getTime())));
                document.getElementById('startDateFilter').value = minDate.toISOString().split('T')[0];
                document.getElementById('endDateFilter').value = maxDate.toISOString().split('T')[0];
            } else {
                document.getElementById('startDateFilter').value = '';
                document.getElementById('endDateFilter').value = '';
            }
            applyFilters();
        }

        // --- Dashboard Rendering ---
        function renderDashboard() {
            destroyCharts();
            updateKPIs();

            const activeTab = document.querySelector('.tab-button.active').dataset.tab;
            switch (activeTab) {
                case 'executiva':
                    renderMonthlyRevenueChart();
                    renderGoalAchievementChart();
                    renderServiceMixChart();
                    renderTop5ClientsChart();
                    break;
                case 'operacional':
                    renderRevenueByDayOfWeekChart();
                    renderDailyProductivityChart();
                    renderServicesHeatmapChart();
                    renderPaymentMethodsChart();
                    renderAvgTicketByServiceChart();
                    renderRevenueByFortnightChart();
                    break;
                case 'clientes':
                    renderTop10ClientsChart();
                    renderClientFrequencyChart();
                    renderNewRecurringClientsChart();
                    renderParetoChart();
                    break;
                case 'financeira':
                    renderPaymentMethodsEvolutionChart();
                    renderCommissionDistributionChart();
                    renderGoalGapWaterfallChart();
                    renderSeasonalityChart();
                    renderYoYComparisonChart();
                    break;
            }
        }

        function updateKPIs() {
            const totalRevenue = filteredData.reduce((sum, row) => sum + row.Valor, 0);
            const totalServices = filteredData.length;
            const uniqueClients = new Set(filteredData.map(row => row.Nome)).size;
            const jeanCommission = filteredData.reduce((sum, row) => sum + row['Comiss√£o Jean'], 0);
            const reinoCommission = filteredData.reduce((sum, row) => sum + row['Comiss√£o Reino da Barba'], 0);

            const averageTicket = totalServices > 0 ? totalRevenue / totalServices : 0;

            // For MoM and Goal Achievement, we need to determine the "current month" from the filtered data
            // This is tricky if filters span multiple months. Let's take the latest month in filtered data.
            let currentMonthRevenue = 0;
            let previousMonthRevenue = 0;
            let currentMonthGoal = 0;
            let currentMonthClientsGoal = 0;
            let momGrowth = 0;

            if (filteredData.length > 0) {
                const sortedDates = filteredData.map(d => d.FullDate).sort((a, b) => a - b);
                const latestDate = sortedDates[sortedDates.length - 1];
                const latestYear = latestDate.getFullYear();
                const latestMonth = latestDate.getMonth() + 1; // 1-indexed

                const currentMonthData = filteredData.filter(d => d.Ano === latestYear && d.M√™s === latestMonth);
                currentMonthRevenue = currentMonthData.reduce((sum, row) => sum + row.Valor, 0);

                const prevMonthDate = new Date(latestYear, latestMonth - 2, 1); // Month - 2 because Date constructor is 0-indexed
                const prevMonthYear = prevMonthDate.getFullYear();
                const prevMonth = prevMonthDate.getMonth() + 1;

                const previousMonthData = rawData.filter(d => d.Ano === prevMonthYear && d.M√™s === prevMonth);
                previousMonthRevenue = previousMonthData.reduce((sum, row) => sum + row.Valor, 0);

                momGrowth = calculateMoMChange(currentMonthRevenue, previousMonthRevenue);

                const goalKey = `${latestYear}-${latestMonth}`;
                if (goalsData[goalKey]) {
                    currentMonthGoal = goalsData[goalKey].metaMensal;
                    currentMonthClientsGoal = goalsData[goalKey].metaClientes;
                }
            }

            const goalAchievement = currentMonthGoal > 0 ? (currentMonthRevenue / currentMonthGoal) * 100 : 0;

            const uniqueDates = new Set(filteredData.map(d => d.FullDate.toISOString().split('T')[0])).size;
            const avgServicesPerDay = uniqueDates > 0 ? totalServices / uniqueDates : 0;

            // Retention Rate (simplified for dashboard)
            // Count clients who visited in the current filtered period AND visited in the previous period (relative to filtered period)
            let retentionRate = 0;
            if (filteredData.length > 0) {
                const minDate = new Date(Math.min(...filteredData.map(d => d.FullDate.getTime())));
                const maxDate = new Date(Math.max(...filteredData.map(d => d.FullDate.getTime())));

                // Define "current period" as the filtered data's date range
                // Define "previous period" as the same duration immediately preceding the filtered period
                const durationMs = maxDate.getTime() - minDate.getTime();
                const prevPeriodMaxDate = new Date(minDate.getTime() - 1);
                const prevPeriodMinDate = new Date(prevPeriodMaxDate.getTime() - durationMs);

                const clientsInCurrentPeriod = new Set(filteredData.map(d => d.Nome));
                const clientsInPrevPeriod = new Set(rawData.filter(d => d.FullDate >= prevPeriodMinDate && d.FullDate <= prevPeriodMaxDate).map(d => d.Nome));

                let retainedClients = 0;
                clientsInCurrentPeriod.forEach(client => {
                    if (clientsInPrevPeriod.has(client)) {
                        retainedClients++;
                    }
                });
                retentionRate = clientsInPrevPeriod.size > 0 ? (retainedClients / clientsInPrevPeriod.size) * 100 : 0;
            }


            document.getElementById('kpiTotalRevenue').textContent = formatCurrency(totalRevenue);
            document.getElementById('kpiAverageTicket').textContent = formatCurrency(averageTicket);
            document.getElementById('kpiTotalClients').textContent = uniqueClients.toLocaleString('pt-BR');
            document.getElementById('kpiGoalAchievement').textContent = formatPercentage(goalAchievement);
            document.getElementById('kpiJeanCommission').textContent = formatCurrency(jeanCommission);
            document.getElementById('kpiReinoCommission').textContent = formatCurrency(reinoCommission);

            const kpiMoMGrowth = document.getElementById('kpiMoMGrowth');
            kpiMoMGrowth.textContent = formatPercentage(momGrowth);
            kpiMoMGrowth.className = `value ${momGrowth >= 0 ? 'positive' : 'negative'}`;

            document.getElementById('kpiAvgServicesPerDay').textContent = avgServicesPerDay.toFixed(1);
            document.getElementById('kpiRetentionRate').textContent = formatPercentage(retentionRate);

            // Update gauge chart if it exists
            if (charts.goalAchievementChart) {
                charts.goalAchievementChart.data.datasets[0].data = [goalAchievement, 100 - goalAchievement];
                charts.goalAchievementChart.update();
            }
        }

        // --- Chart Rendering Functions ---
        function renderMonthlyRevenueChart() {
            const ctx = document.getElementById('monthlyRevenueChart').getContext('2d');
            const monthlyData = {};

            filteredData.forEach(row => {
                const monthKey = `${row.Ano}-${row.M√™s.toString().padStart(2, '0')}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { revenue: 0, goal: 0 };
                }
                monthlyData[monthKey].revenue += row.Valor;
                // Get goal from goalsData, not filteredData, to ensure consistent goal
                const goalKey = `${row.Ano}-${row.M√™s}`;
                if (goalsData[goalKey]) {
                    monthlyData[monthKey].goal = goalsData[goalKey].metaMensal;
                }
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const labels = sortedMonths.map(key => {
                const [year, month] = key.split('-');
                return `${getMonthName(parseInt(month))}/${year.slice(2)}`;
            });
            const revenues = sortedMonths.map(key => monthlyData[key].revenue);
            const goals = sortedMonths.map(key => monthlyData[key].goal);

            charts.monthlyRevenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Faturamento Real',
                            data: revenues,
                            borderColor: varColor('--primary-color'),
                            backgroundColor: varColor('--primary-color', 0.2),
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Meta Mensal',
                            data: goals,
                            borderColor: varColor('--secondary-color'),
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Faturamento Mensal vs. Meta',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'M√™s', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') }
                        }
                    }
                }
            });
        }

        function renderGoalAchievementChart() {
            const ctx = document.getElementById('goalAchievementChart').getContext('2d');
            let currentMonthRevenue = 0;
            let currentMonthGoal = 0;

            if (filteredData.length > 0) {
                const sortedDates = filteredData.map(d => d.FullDate).sort((a, b) => a - b);
                const latestDate = sortedDates[sortedDates.length - 1];
                const latestYear = latestDate.getFullYear();
                const latestMonth = latestDate.getMonth() + 1;

                const currentMonthData = filteredData.filter(d => d.Ano === latestYear && d.M√™s === latestMonth);
                currentMonthRevenue = currentMonthData.reduce((sum, row) => sum + row.Valor, 0);

                const goalKey = `${latestYear}-${latestMonth}`;
                if (goalsData[goalKey]) {
                    currentMonthGoal = goalsData[goalKey].metaMensal;
                }
            }

            const achievement = currentMonthGoal > 0 ? (currentMonthRevenue / currentMonthGoal) * 100 : 0;
            const data = [Math.min(achievement, 100), Math.max(0, 100 - achievement)]; // Cap at 100% for visual

            charts.goalAchievementChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Atingido', 'Restante'],
                    datasets: [{
                        data: data,
                        backgroundColor: [varColor('--secondary-color'), varColor('--border-color')],
                        borderColor: varColor('--card-bg'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    circumference: 180, // Half circle
                    rotation: -90, // Start from top
                    cutout: '70%',
                    plugins: {
                        title: {
                            display: true,
                            text: 'Atingimento da Meta Mensal',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) label += formatPercentage(context.parsed);
                                    return label;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                if (ctx.dataIndex === 0) return formatPercentage(value);
                                return ''; // Only show for the 'achieved' part
                            },
                            color: varColor('--text-color'),
                            font: { size: 16, weight: 'bold' }
                        }
                    },
                    elements: {
                        arc: {
                            borderWidth: 0
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderServiceMixChart() {
            const ctx = document.getElementById('serviceMixChart').getContext('2d');
            const serviceMix = {};
            filteredData.forEach(row => {
                serviceMix[row['Tipo de Servi√ßo']] = (serviceMix[row['Tipo de Servi√ßo']] || 0) + row.Valor;
            });

            const labels = Object.keys(serviceMix);
            const data = Object.values(serviceMix);
            const backgroundColors = labels.map((_, i) => getChartColors(i));
            const borderColors = labels.map((_, i) => getChartBorderColors(i));

            charts.serviceMixChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Mix de Servi√ßos (Faturamento %)',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) label += formatCurrency(context.parsed);
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return `(${percentage.toFixed(1)}%)`;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((sum, val) => sum + val, 0);
                                const percentage = (value / total) * 100;
                                return percentage > 5 ? `${percentage.toFixed(1)}%` : ''; // Only show if > 5%
                            },
                            color: '#fff',
                            font: { weight: 'bold' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderTop5ClientsChart() {
            const ctx = document.getElementById('top5ClientsChart').getContext('2d');
            const clientRevenue = {};
            filteredData.forEach(row => {
                clientRevenue[row.Nome] = (clientRevenue[row.Nome] || 0) + row.Valor;
            });

            const sortedClients = Object.entries(clientRevenue)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            const labels = sortedClients.map(([name]) => name);
            const data = sortedClients.map(([, revenue]) => revenue);

            charts.top5ClientsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento',
                        data: data,
                        backgroundColor: labels.map((_, i) => getChartColors(i)),
                        borderColor: labels.map((_, i) => getChartBorderColors(i)),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bar chart
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 5 Clientes por Faturamento',
                            color: varColor('--text-color')
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.x !== null) label += formatCurrency(context.parsed.x);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Cliente', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        }
                    }
                }
            });
        }

        function renderRevenueByDayOfWeekChart() {
            const ctx = document.getElementById('revenueByDayOfWeekChart').getContext('2d');
            const revenueByDay = Array(7).fill(0); // 0: Dom, 1: Seg, ..., 6: S√°b

            filteredData.forEach(row => {
                revenueByDay[row['Dia da Semana']] += row.Valor;
            });

            const labels = dayOfWeekNames.map(name => name);
            const data = revenueByDay;

            charts.revenueByDayOfWeekChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento',
                        data: data,
                        backgroundColor: labels.map((_, i) => getChartColors(i)),
                        borderColor: labels.map((_, i) => getChartBorderColors(i)),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Faturamento por Dia da Semana',
                            color: varColor('--text-color')
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Dia da Semana', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') }
                        }
                    }
                }
            });
        }

        function renderDailyProductivityChart() {
            const ctx = document.getElementById('dailyProductivityChart').getContext('2d');
            const dailyServices = {};

            filteredData.forEach(row => {
                const dateKey = row.FullDate.toISOString().split('T')[0];
                dailyServices[dateKey] = (dailyServices[dateKey] || 0) + 1;
            });

            const sortedDates = Object.keys(dailyServices).sort();
            const labels = sortedDates.map(date => new Date(date).toLocaleDateString('pt-BR', { day: '2-digit', month: 'short' }));
            const data = sortedDates.map(date => dailyServices[date]);

            charts.dailyProductivityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Servi√ßos por Dia',
                        data: data,
                        borderColor: varColor('--primary-color'),
                        backgroundColor: varColor('--primary-color', 0.2),
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Produtividade Di√°ria (Servi√ßos)',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y.toLocaleString('pt-BR');
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Data', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'N¬∫ de Servi√ßos', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderServicesHeatmapChart() {
            const ctx = document.getElementById('servicesHeatmapChart').getContext('2d');
            const serviceTypes = [...new Set(rawData.map(d => d['Tipo de Servi√ßo']))].sort(); // Use rawData for consistent labels
            const daysOfWeek = Array.from({ length: 7 }, (_, i) => i); // 0-6

            const heatmapData = {};
            serviceTypes.forEach(service => {
                heatmapData[service] = Array(7).fill(0);
            });

            filteredData.forEach(row => {
                const serviceIndex = serviceTypes.indexOf(row['Tipo de Servi√ßo']);
                if (serviceIndex !== -1) {
                    heatmapData[row['Tipo de Servi√ßo']][row['Dia da Semana']] += 1;
                }
            });

            const datasets = [];
            let maxCount = 0;
            serviceTypes.forEach((service, serviceIdx) => {
                daysOfWeek.forEach(dayIdx => {
                    const count = heatmapData[service][dayIdx];
                    if (count > maxCount) maxCount = count;
                    datasets.push({
                        x: getFullWeekDayName(dayIdx),
                        y: service,
                        v: count
                    });
                });
            });

            // Custom Chart.js type for heatmap (simplified for this context, using scatter with custom drawing)
            // This is a complex chart type for Chart.js. A simpler approach is to use a library or custom draw.
            // For a single HTML file, a custom drawing on canvas or a table-like representation might be easier.
            // Let's simulate with a bar chart where each bar represents a cell, and color indicates value.
            // This will be a grouped bar chart, but it won't look like a true heatmap matrix.
            // A true heatmap requires a custom Chart.js plugin or a different library.
            // Given the constraint, I'll use a stacked bar chart to represent this, which is a compromise.

            // Alternative: Create a grid of divs and color them. This is not a Chart.js chart.
            // For a Chart.js solution, a custom plugin would be needed, which is too complex for this context.
            // I will implement a simplified version using a table-like structure with colored cells.
            // This will be rendered outside of Chart.js canvas.

            const chartContainer = document.getElementById('servicesHeatmapChart').parentNode;
            chartContainer.innerHTML = `
                <h3 style="color: ${varColor('--text-color')}; margin-bottom: 1rem;">Servi√ßos por Dia da Semana (Heatmap)</h3>
                <div id="heatmapTable" style="display: grid; grid-template-columns: auto repeat(7, 1fr); gap: 2px; width: 100%; text-align: center;">
                    <div style="background-color: ${varColor('--bg-color')}; padding: 0.5rem; font-weight: bold; color: ${varColor('--text-color')}">Servi√ßo \ Dia</div>
                    ${daysOfWeek.map(d => `<div style="background-color: ${varColor('--bg-color')}; padding: 0.5rem; font-weight: bold; color: ${varColor('--text-color')}">${getWeekDayName(d)}</div>`).join('')}
                    ${serviceTypes.map(service => `
                        <div style="background-color: ${varColor('--bg-color')}; padding: 0.5rem; font-weight: bold; color: ${varColor('--text-color')}">${service}</div>
                        ${daysOfWeek.map(dayIdx => {
                            const count = heatmapData[service][dayIdx];
                            const intensity = maxCount > 0 ? count / maxCount : 0;
                            const bgColor = `rgba(16, 185, 129, ${intensity * 0.8 + 0.2})`; // Greenish scale
                            const textColor = intensity > 0.5 ? 'white' : varColor('--text-color');
                            return `<div style="background-color: ${bgColor}; padding: 0.5rem; color: ${textColor};">${count}</div>`;
                        }).join('')}
                    `).join('')}
                </div>
            `;
            // No Chart.js instance to store for this "chart"
        }

        function renderPaymentMethodsChart() {
            const ctx = document.getElementById('paymentMethodsChart').getContext('2d');
            const paymentMethodData = {};
            filteredData.forEach(row => {
                paymentMethodData[row['Forma de Pagamento']] = (paymentMethodData[row['Forma de Pagamento']] || 0) + row.Valor;
            });

            const labels = Object.keys(paymentMethodData);
            const data = Object.values(paymentMethodData);
            const backgroundColors = labels.map((_, i) => getChartColors(i));
            const borderColors = labels.map((_, i) => getChartBorderColors(i));

            charts.paymentMethodsChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o de Formas de Pagamento',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed !== null) label += formatCurrency(context.parsed);
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = (context.parsed / total) * 100;
                                    return `(${percentage.toFixed(1)}%)`;
                                }
                            }
                        },
                        datalabels: {
                            formatter: (value, ctx) => {
                                const total = ctx.dataset.data.reduce((sum, val) => sum + val, 0);
                                const percentage = (value / total) * 100;
                                return percentage > 5 ? `${percentage.toFixed(1)}%` : '';
                            },
                            color: '#fff',
                            font: { weight: 'bold' }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderAvgTicketByServiceChart() {
            const ctx = document.getElementById('avgTicketByServiceChart').getContext('2d');
            const serviceStats = {}; // { service: { totalRevenue: 0, count: 0 } }

            filteredData.forEach(row => {
                if (!serviceStats[row['Tipo de Servi√ßo']]) {
                    serviceStats[row['Tipo de Servi√ßo']] = { totalRevenue: 0, count: 0 };
                }
                serviceStats[row['Tipo de Servi√ßo']].totalRevenue += row.Valor;
                serviceStats[row['Tipo de Servi√ßo']].count += 1;
            });

            const labels = Object.keys(serviceStats);
            const data = labels.map(service => {
                const stats = serviceStats[service];
                return stats.count > 0 ? stats.totalRevenue / stats.count : 0;
            });

            charts.avgTicketByServiceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ticket M√©dio',
                        data: data,
                        backgroundColor: labels.map((_, i) => getChartColors(i)),
                        borderColor: labels.map((_, i) => getChartBorderColors(i)),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Ticket M√©dio por Tipo de Servi√ßo',
                            color: varColor('--text-color')
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Tipo de Servi√ßo', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderRevenueByFortnightChart() {
            const ctx = document.getElementById('revenueByFortnightChart').getContext('2d');
            const monthlyFortnightData = {}; // { 'YYYY-MM': { '1¬™': 0, '2¬™': 0 } }

            filteredData.forEach(row => {
                const monthKey = `${row.Ano}-${row.M√™s.toString().padStart(2, '0')}`;
                if (!monthlyFortnightData[monthKey]) {
                    monthlyFortnightData[monthKey] = { '1¬™': 0, '2¬™': 0 };
                }
                const quinzena = row.Dia <= 15 ? '1¬™' : '2¬™';
                monthlyFortnightData[monthKey][quinzena] += row.Valor;
            });

            const sortedMonths = Object.keys(monthlyFortnightData).sort();
            const labels = sortedMonths.map(key => {
                const [year, month] = key.split('-');
                return `${getMonthName(parseInt(month))}/${year.slice(2)}`;
            });
            const firstFortnightData = sortedMonths.map(key => monthlyFortnightData[key]['1¬™']);
            const secondFortnightData = sortedMonths.map(key => monthlyFortnightData[key]['2¬™']);

            charts.revenueByFortnightChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '1¬™ Quinzena',
                            data: firstFortnightData,
                            backgroundColor: varColor('--primary-color'),
                            borderColor: varColor('--primary-color'),
                            borderWidth: 1
                        },
                        {
                            label: '2¬™ Quinzena',
                            data: secondFortnightData,
                            backgroundColor: varColor('--secondary-color'),
                            borderColor: varColor('--secondary-color'),
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Faturamento por Quinzena',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'M√™s', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderTop10ClientsChart() {
            const ctx = document.getElementById('top10ClientsChart').getContext('2d');
            const clientRevenue = {};
            filteredData.forEach(row => {
                clientRevenue[row.Nome] = (clientRevenue[row.Nome] || 0) + row.Valor;
            });

            const sortedClients = Object.entries(clientRevenue)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 10);

            const labels = sortedClients.map(([name]) => name);
            const data = sortedClients.map(([, revenue]) => revenue);

            charts.top10ClientsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento',
                        data: data,
                        backgroundColor: labels.map((_, i) => getChartColors(i)),
                        borderColor: labels.map((_, i) => getChartBorderColors(i)),
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bar chart
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Top 10 Clientes por Faturamento',
                            color: varColor('--text-color')
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.x !== null) label += formatCurrency(context.parsed.x);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Cliente', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        }
                    }
                }
            });
        }

        function renderClientFrequencyChart() {
            const ctx = document.getElementById('clientFrequencyChart').getContext('2d');
            const clientVisits = {};
            filteredData.forEach(row => {
                clientVisits[row.Nome] = (clientVisits[row.Nome] || 0) + 1;
            });

            const frequencyBins = {
                '1x': 0,
                '2x': 0,
                '3x': 0,
                '4-5x': 0,
                '6+x': 0
            };

            Object.values(clientVisits).forEach(visits => {
                if (visits === 1) frequencyBins['1x']++;
                else if (visits === 2) frequencyBins['2x']++;
                else if (visits === 3) frequencyBins['3x']++;
                else if (visits >= 4 && visits <= 5) frequencyBins['4-5x']++;
                else if (visits >= 6) frequencyBins['6+x']++;
            });

            const labels = Object.keys(frequencyBins);
            const data = Object.values(frequencyBins);

            charts.clientFrequencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'N√∫mero de Clientes',
                        data: data,
                        backgroundColor: labels.map((_, i) => getChartColors(i)),
                        borderColor: labels.map((_, i) => getChartBorderColors(i)),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Frequ√™ncia de Visitas dos Clientes',
                            color: varColor('--text-color')
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y.toLocaleString('pt-BR');
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'N√∫mero de Visitas', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'N¬∫ de Clientes', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderNewRecurringClientsChart() {
            const ctx = document.getElementById('newRecurringClientsChart').getContext('2d');
            const monthlyClientData = {}; // { 'YYYY-MM': { new: Set(), recurring: Set(), allClientsInMonth: Set() } }
            const clientFirstVisit = {}; // { clientName: Date }

            // First pass: determine first visit for each client from ALL rawData
            rawData.forEach(row => {
                if (!clientFirstVisit[row.Nome] || row.FullDate < clientFirstVisit[row.Nome]) {
                    clientFirstVisit[row.Nome] = row.FullDate;
                }
            });

            // Second pass: categorize clients in filteredData
            filteredData.forEach(row => {
                const monthKey = `${row.Ano}-${row.M√™s.toString().padStart(2, '0')}`;
                if (!monthlyClientData[monthKey]) {
                    monthlyClientData[monthKey] = { new: new Set(), recurring: new Set(), allClientsInMonth: new Set() };
                }
                monthlyClientData[monthKey].allClientsInMonth.add(row.Nome);
            });

            const sortedMonths = Object.keys(monthlyClientData).sort();
            const labels = sortedMonths.map(key => {
                const [year, month] = key.split('-');
                return `${getMonthName(parseInt(month))}/${year.slice(2)}`;
            });

            const newClientsCount = [];
            const recurringClientsCount = [];

            sortedMonths.forEach(monthKey => {
                const [year, month] = monthKey.split('-');
                const currentMonthStart = new Date(parseInt(year), parseInt(month) - 1, 1);

                let newCount = 0;
                let recurringCount = 0;

                monthlyClientData[monthKey].allClientsInMonth.forEach(clientName => {
                    if (clientFirstVisit[clientName].getFullYear() === currentMonthStart.getFullYear() &&
                        clientFirstVisit[clientName].getMonth() === currentMonthStart.getMonth()) {
                        newCount++;
                    } else {
                        recurringCount++;
                    }
                });
                newClientsCount.push(newCount);
                recurringClientsCount.push(recurringCount);
            });

            charts.newRecurringClientsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Novos Clientes',
                            data: newClientsCount,
                            borderColor: varColor('--primary-color'),
                            backgroundColor: varColor('--primary-color', 0.2),
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Clientes Recorrentes',
                            data: recurringClientsCount,
                            borderColor: varColor('--secondary-color'),
                            backgroundColor: varColor('--secondary-color', 0.2),
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Novos vs. Clientes Recorrentes (Mensal)',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y.toLocaleString('pt-BR');
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'M√™s', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'N¬∫ de Clientes', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderParetoChart() {
            const ctx = document.getElementById('paretoChart').getContext('2d');
            const clientRevenue = {};
            filteredData.forEach(row => {
                clientRevenue[row.Nome] = (clientRevenue[row.Nome] || 0) + row.Valor;
            });

            const sortedClients = Object.entries(clientRevenue)
                .sort(([, a], [, b]) => b - a);

            const labels = sortedClients.map(([name]) => name);
            const revenues = sortedClients.map(([, revenue]) => revenue);

            let cumulativeRevenue = 0;
            const totalRevenue = revenues.reduce((sum, val) => sum + val, 0);
            const cumulativePercentages = revenues.map(rev => {
                cumulativeRevenue += rev;
                return (cumulativeRevenue / totalRevenue) * 100;
            });

            charts.paretoChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Faturamento por Cliente',
                            data: revenues,
                            backgroundColor: varColor('--primary-color'),
                            borderColor: varColor('--primary-color'),
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Faturamento Acumulado (%)',
                            data: cumulativePercentages,
                            type: 'line',
                            borderColor: varColor('--accent-color'),
                            backgroundColor: 'transparent',
                            fill: false,
                            yAxisID: 'y1',
                            tension: 0.3,
                            pointRadius: 3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Curva ABC de Clientes (Faturamento)',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.dataset.type === 'line') {
                                        label += formatPercentage(context.parsed.y);
                                    } else {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Cliente', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            type: 'linear',
                            position: 'left',
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            title: { display: true, text: 'Acumulado (%)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatPercentage(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { drawOnChartArea: false, color: varColor('--chart-grid-color') },
                            min: 0,
                            max: 100
                        }
                    }
                }
            });
        }

        function renderPaymentMethodsEvolutionChart() {
            const ctx = document.getElementById('paymentMethodsEvolutionChart').getContext('2d');
            const monthlyPaymentData = {}; // { 'YYYY-MM': { PIX: 0, CR√âDITO: 0, D√âBITO: 0 } }
            const allPaymentMethods = [...new Set(rawData.map(d => d['Forma de Pagamento']))].sort();

            filteredData.forEach(row => {
                const monthKey = `${row.Ano}-${row.M√™s.toString().padStart(2, '0')}`;
                if (!monthlyPaymentData[monthKey]) {
                    monthlyPaymentData[monthKey] = {};
                    allPaymentMethods.forEach(method => monthlyPaymentData[monthKey][method] = 0);
                }
                monthlyPaymentData[monthKey][row['Forma de Pagamento']] += row.Valor;
            });

            const sortedMonths = Object.keys(monthlyPaymentData).sort();
            const labels = sortedMonths.map(key => {
                const [year, month] = key.split('-');
                return `${getMonthName(parseInt(month))}/${year.slice(2)}`;
            });

            const datasets = allPaymentMethods.map((method, i) => ({
                label: method,
                data: sortedMonths.map(key => monthlyPaymentData[key][method] || 0),
                backgroundColor: getChartColors(i),
                borderColor: getChartBorderColors(i),
                fill: true,
                tension: 0.3
            }));

            charts.paymentMethodsEvolutionChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Evolu√ß√£o das Formas de Pagamento (Mensal)',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'M√™s', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            stacked: true,
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderCommissionDistributionChart() {
            const ctx = document.getElementById('commissionDistributionChart').getContext('2d');
            const monthlyCommissionData = {}; // { 'YYYY-MM': { jean: 0, reino: 0 } }

            filteredData.forEach(row => {
                const monthKey = `${row.Ano}-${row.M√™s.toString().padStart(2, '0')}`;
                if (!monthlyCommissionData[monthKey]) {
                    monthlyCommissionData[monthKey] = { jean: 0, reino: 0 };
                }
                monthlyCommissionData[monthKey].jean += row['Comiss√£o Jean'];
                monthlyCommissionData[monthKey].reino += row['Comiss√£o Reino da Barba'];
            });

            const sortedMonths = Object.keys(monthlyCommissionData).sort();
            const labels = sortedMonths.map(key => {
                const [year, month] = key.split('-');
                return `${getMonthName(parseInt(month))}/${year.slice(2)}`;
            });
            const jeanCommissions = sortedMonths.map(key => monthlyCommissionData[key].jean);
            const reinoCommissions = sortedMonths.map(key => monthlyCommissionData[key].reino);

            charts.commissionDistributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Comiss√£o Jean',
                            data: jeanCommissions,
                            backgroundColor: varColor('--primary-color'),
                            borderColor: varColor('--primary-color'),
                            borderWidth: 1
                        },
                        {
                            label: 'Comiss√£o Reino da Barba',
                            data: reinoCommissions,
                            backgroundColor: varColor('--secondary-color'),
                            borderColor: varColor('--secondary-color'),
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o de Comiss√µes (Mensal)',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'M√™s', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            stacked: true,
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderGoalGapWaterfallChart() {
            const ctx = document.getElementById('goalGapWaterfallChart').getContext('2d');
            // For simplicity, let's focus on the latest month in the filtered data
            let latestMonthRevenue = 0;
            let latestMonthGoal = 0;
            let monthLabel = 'N/A';

            if (filteredData.length > 0) {
                const sortedDates = filteredData.map(d => d.FullDate).sort((a, b) => a - b);
                const latestDate = sortedDates[sortedDates.length - 1];
                const latestYear = latestDate.getFullYear();
                const latestMonth = latestDate.getMonth() + 1;

                const currentMonthData = filteredData.filter(d => d.Ano === latestYear && d.M√™s === latestMonth);
                latestMonthRevenue = currentMonthData.reduce((sum, row) => sum + row.Valor, 0);

                const goalKey = `${latestYear}-${latestMonth}`;
                if (goalsData[goalKey]) {
                    latestMonthGoal = goalsData[goalKey].metaMensal;
                }
                monthLabel = `${getFullMonthName(latestMonth)}/${latestYear}`;
            }

            const gap = latestMonthGoal - latestMonthRevenue;

            const data = {
                labels: ['Meta', 'Realizado', 'Diferen√ßa'],
                datasets: [{
                    label: 'Faturamento',
                    data: [latestMonthGoal, latestMonthRevenue, gap],
                    backgroundColor: [
                        varColor('--primary-color'), // Meta
                        varColor('--secondary-color'), // Realizado
                        gap >= 0 ? varColor('--accent-color') : '#ef4444' // Diferen√ßa (orange for positive gap, red for negative)
                    ],
                    borderColor: [
                        varColor('--primary-color'),
                        varColor('--secondary-color'),
                        gap >= 0 ? varColor('--accent-color') : '#ef4444'
                    ],
                    borderWidth: 1
                }]
            };

            charts.goalGapWaterfallChart = new Chart(ctx, {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `An√°lise de Diferen√ßa da Meta (${monthLabel})`,
                            color: varColor('--text-color')
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Item', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') }
                        }
                    }
                }
            });
        }

        function renderSeasonalityChart() {
            const ctx = document.getElementById('seasonalityChart').getContext('2d');
            const monthlyRevenue = {}; // { 'YYYY-MM': revenue }

            filteredData.forEach(row => {
                const monthKey = `${row.Ano}-${row.M√™s.toString().padStart(2, '0')}`;
                monthlyRevenue[monthKey] = (monthlyRevenue[monthKey] || 0) + row.Valor;
            });

            const sortedMonths = Object.keys(monthlyRevenue).sort();
            const labels = sortedMonths.map(key => {
                const [year, month] = key.split('-');
                return `${getMonthName(parseInt(month))}/${year.slice(2)}`;
            });
            const revenues = sortedMonths.map(key => monthlyRevenue[key]);

            // Calculate 3-month moving average
            const movingAverage = [];
            for (let i = 0; i < revenues.length; i++) {
                if (i < 2) { // Not enough data for 3-month average
                    movingAverage.push(null);
                } else {
                    const sum = revenues[i] + revenues[i - 1] + revenues[i - 2];
                    movingAverage.push(sum / 3);
                }
            }

            charts.seasonalityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Faturamento Mensal',
                            data: revenues,
                            borderColor: varColor('--primary-color'),
                            backgroundColor: varColor('--primary-color', 0.2),
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: 'M√©dia M√≥vel (3 meses)',
                            data: movingAverage,
                            borderColor: varColor('--accent-color'),
                            backgroundColor: 'transparent',
                            borderDash: [5, 5],
                            tension: 0.3,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'An√°lise de Sazonalidade (Faturamento Mensal)',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'M√™s', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function renderYoYComparisonChart() {
            const ctx = document.getElementById('yoyComparisonChart').getContext('2d');
            const yearlyMonthlyRevenue = {}; // { 'YYYY': { 'MM': revenue } }

            rawData.forEach(row => { // Use rawData for full year comparison
                if (!yearlyMonthlyRevenue[row.Ano]) {
                    yearlyMonthlyRevenue[row.Ano] = {};
                    for (let m = 1; m <= 12; m++) yearlyMonthlyRevenue[row.Ano][m] = 0;
                }
                yearlyMonthlyRevenue[row.Ano][row.M√™s] += row.Valor;
            });

            const availableYears = Object.keys(yearlyMonthlyRevenue).sort();
            const labels = Array.from({ length: 12 }, (_, i) => getMonthName(i + 1));

            const datasets = availableYears.map((year, i) => ({
                label: `Faturamento ${year}`,
                data: labels.map((_, monthIdx) => yearlyMonthlyRevenue[year][monthIdx + 1] || 0),
                backgroundColor: getChartColors(i),
                borderColor: getChartBorderColors(i),
                borderWidth: 1
            }));

            charts.yoyComparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Comparativo Anual de Faturamento (YoY)',
                            color: varColor('--text-color')
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += formatCurrency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'M√™s', color: varColor('--chart-text-color') },
                            ticks: { color: varColor('--chart-text-color') },
                            grid: { color: varColor('--chart-grid-color') }
                        },
                        y: {
                            title: { display: true, text: 'Valor (R$)', color: varColor('--chart-text-color') },
                            ticks: {
                                callback: function(value) { return formatCurrency(value); },
                                color: varColor('--chart-text-color')
                            },
                            grid: { color: varColor('--chart-grid-color') },
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Helper to get CSS variable color, with optional alpha for transparency
        function varColor(varName, alpha = 1) {
            const color = getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            if (alpha === 1) return color;
            // Convert hex to rgba if necessary
            if (color.startsWith('#')) {
                let r = parseInt(color.slice(1, 3), 16);
                let g = parseInt(color.slice(3, 5), 16);
                let b = parseInt(color.slice(5, 7), 16);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
            // Assume it's already rgba or rgb
            return color.replace(/rgb\((.+)\)/, `rgba($1, ${alpha})`);
        }

        // --- Event Listeners ---
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        document.getElementById('applyFiltersBtn').addEventListener('click', applyFilters);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);

        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                document.getElementById(button.dataset.tab).classList.add('active');

                // Re-render charts for the newly active tab
                renderDashboard();
            });
        });

        // Initial dashboard render (empty until data is loaded)
        renderDashboard();
    </script>
</body>
</html>
