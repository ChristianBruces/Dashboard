<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Reino da Barba</title>
    
    <!-- CDN Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-light: #f8fafc;
            --bg-dark: #0f172a;
            --card-light: #ffffff;
            --card-dark: #1e293b;
            --text-light: #1e293b;
            --text-dark: #f1f5f9;
            --border-light: #e2e8f0;
            --border-dark: #334155;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-light);
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: var(--bg-dark);
            color: var(--text-dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background: var(--card-light);
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        body.dark-mode header {
            background: var(--card-dark);
        }

        header h1 {
            font-size: 28px;
            color: var(--primary);
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        button, .file-upload-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        #theme-toggle {
            background: var(--warning);
            color: white;
        }

        /* Filters */
        .filters-section {
            background: var(--card-light);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        body.dark-mode .filters-section {
            background: var(--card-dark);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .filter-item label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }

        select, input[type="date"] {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-light);
            border-radius: 6px;
            background: var(--card-light);
            color: var(--text-light);
            font-size: 14px;
        }

        body.dark-mode select,
        body.dark-mode input[type="date"] {
            background: var(--bg-dark);
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        /* KPIs */
        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--card-light);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s;
        }

        body.dark-mode .kpi-card {
            background: var(--card-dark);
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }

        .kpi-title {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .kpi-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .kpi-change {
            font-size: 14px;
            font-weight: 600;
        }

        .kpi-change.positive {
            color: var(--success);
        }

        .kpi-change.negative {
            color: var(--danger);
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            border: none;
            background: var(--card-light);
            color: var(--text-light);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        body.dark-mode .tab {
            background: var(--card-dark);
            color: var(--text-dark);
        }

        .tab.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 25px;
        }

        .chart-container {
            background: var(--card-light);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        body.dark-mode .chart-container {
            background: var(--card-dark);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-light);
        }

        body.dark-mode .chart-title {
            color: var(--text-dark);
        }

        /* Heatmap */
        .heatmap-container {
            overflow-x: auto;
        }

        .heatmap-table {
            width: 100%;
            border-collapse: collapse;
        }

        .heatmap-table th,
        .heatmap-table td {
            padding: 15px;
            text-align: center;
            border: 1px solid var(--border-light);
        }

        body.dark-mode .heatmap-table th,
        body.dark-mode .heatmap-table td {
            border-color: var(--border-dark);
        }

        .heatmap-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }

        /* Loading & Error */
        #loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        #loading-overlay.show {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: var(--danger);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .filters-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Hide file input */
        #file-input {
            display: none;
        }

        .file-stats {
            font-size: 14px;
            color: #64748b;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loading-overlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <!-- Header -->
        <header>
            <h1>üíà Dashboard Reino da Barba</h1>
            <div class="header-actions">
                <button id="theme-toggle">üåô Modo Escuro</button>
                <button class="btn-primary" onclick="document.getElementById('file-input').click()">
                    üìÅ Carregar Arquivo
                </button>
                <input type="file" id="file-input" accept=".xlsx,.xls,.csv">
            </div>
        </header>

        <!-- Error Message -->
        <div id="error-message" class="error-message"></div>

        <!-- File Stats -->
        <div id="file-stats" class="file-stats" style="display:none;"></div>

        <!-- Filters -->
        <div class="filters-section">
            <h3>üéõÔ∏è Filtros</h3>
            <div class="filters-grid">
                <div class="filter-item">
                    <label>Ano</label>
                    <select id="filter-ano" multiple></select>
                </div>
                <div class="filter-item">
                    <label>M√™s</label>
                    <select id="filter-mes" multiple></select>
                </div>
                <div class="filter-item">
                    <label>Quinzena</label>
                    <select id="filter-quinzena" multiple></select>
                </div>
                <div class="filter-item">
                    <label>Dia da Semana</label>
                    <select id="filter-dia-semana" multiple></select>
                </div>
                <div class="filter-item">
                    <label>Servi√ßo</label>
                    <select id="filter-servico" multiple></select>
                </div>
                <div class="filter-item">
                    <label>Forma de Pagamento</label>
                    <select id="filter-pagto" multiple></select>
                </div>
                <div class="filter-item">
                    <label>Data In√≠cio</label>
                    <input type="date" id="filter-data-inicio">
                </div>
                <div class="filter-item">
                    <label>Data Fim</label>
                    <input type="date" id="filter-data-fim">
                </div>
            </div>
            <div style="margin-top: 15px;">
                <button class="btn-primary" onclick="applyFilters()">Aplicar Filtros</button>
                <button onclick="clearFilters()">Limpar Filtros</button>
            </div>
        </div>

        <!-- KPIs -->
        <div class="kpis-grid" id="kpis-container"></div>

        <!-- Tabs -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="executiva">üìä Vis√£o Executiva</button>
                <button class="tab" data-tab="operacional">‚öôÔ∏è An√°lise Operacional</button>
                <button class="tab" data-tab="clientes">üë• An√°lise de Clientes</button>
                <button class="tab" data-tab="financeira">üí∞ An√°lise Financeira</button>
            </div>
        </div>

        <!-- Tab Contents -->
        <div id="tab-executiva" class="tab-content active">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Faturamento Mensal vs Meta</h3>
                    <canvas id="chart-revenue-goal"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Atingimento de Meta</h3>
                    <canvas id="chart-goal-gauge"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Mix de Servi√ßos</h3>
                    <canvas id="chart-services-mix"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Top 10 Clientes</h3>
                    <canvas id="chart-top-clients"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-operacional" class="tab-content">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Receita por Dia da Semana</h3>
                    <canvas id="chart-revenue-day-week"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Produtividade Di√°ria</h3>
                    <canvas id="chart-daily-productivity"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Heatmap de Servi√ßos</h3>
                    <div class="heatmap-container" id="heatmap-services"></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Formas de Pagamento</h3>
                    <canvas id="chart-payment-methods"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Ticket M√©dio por Servi√ßo</h3>
                    <canvas id="chart-avg-ticket"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Receita por Quinzena</h3>
                    <canvas id="chart-revenue-fortnight"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-clientes" class="tab-content">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Frequ√™ncia de Clientes</h3>
                    <canvas id="chart-client-frequency"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Novos vs Recorrentes</h3>
                    <canvas id="chart-new-recurring"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Curva ABC (Pareto)</h3>
                    <canvas id="chart-pareto"></canvas>
                </div>
            </div>
        </div>

        <div id="tab-financeira" class="tab-content">
            <div class="charts-grid">
                <div class="chart-container">
                    <h3 class="chart-title">Evolu√ß√£o de Pagamentos</h3>
                    <canvas id="chart-payment-evolution"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Distribui√ß√£o de Comiss√µes</h3>
                    <canvas id="chart-commissions"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Gap de Meta</h3>
                    <canvas id="chart-goal-gap"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Sazonalidade com M√©dia M√≥vel</h3>
                    <canvas id="chart-seasonality"></canvas>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Compara√ß√£o Ano a Ano</h3>
                    <canvas id="chart-yoy"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let rawData = [];
        let filteredData = [];
        let charts = {};
        
        // Theme Toggle
        document.getElementById('theme-toggle').addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            this.textContent = isDark ? '‚òÄÔ∏è Modo Claro' : 'üåô Modo Escuro';
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            // Recreate charts with new theme
            if (rawData.length > 0) {
                createAllCharts();
            }
        });

        // Load theme from localStorage
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.getElementById('theme-toggle').textContent = '‚òÄÔ∏è Modo Claro';
        }

        // Tab Switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById('tab-' + this.dataset.tab).classList.add('active');
            });
        });

        // File Upload
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('loading-overlay').classList.add('show');
            document.getElementById('error-message').classList.remove('show');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    rawData = XLSX.utils.sheet_to_json(firstSheet);
                    
                    if (rawData.length === 0) {
                        throw new Error('O arquivo est√° vazio!');
                    }
                    
                    // Validate required columns
                    const required = ['ano', 'mes', 'dia', 'dia_semana', 'quinzenas', 'cliente', 'servico', 'valor', 'pagto'];
                    const cols = Object.keys(rawData[0]);
                    const missing = required.filter(col => !cols.includes(col));
                    if (missing.length > 0) {
                        throw new Error(`Colunas obrigat√≥rias n√£o encontradas: ${missing.join(', ')}`);
                    }
                    
                    // Show file stats
                    document.getElementById('file-stats').style.display = 'block';
                    document.getElementById('file-stats').innerHTML = `
                        ‚úÖ Arquivo carregado: <strong>${file.name}</strong> | 
                        ${rawData.length} registros | 
                        ${cols.length} colunas
                    `;
                    
                    filteredData = [...rawData];
                    populateFilters();
                    updateDashboard();
                } catch (error) {
                    showError(error.message);
                } finally {
                    document.getElementById('loading-overlay').classList.remove('show');
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = '‚ùå Erro: ' + message;
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        // Populate Filters
        function populateFilters() {
            const anos = [...new Set(rawData.map(d => d.ano))].sort();
            const meses = [...new Set(rawData.map(d => d.mes))].sort((a, b) => a - b);
            const quinzenas = [...new Set(rawData.map(d => d.quinzenas))].sort();
            const diasSemana = [...new Set(rawData.map(d => d.dia_semana))];
            const servicos = [...new Set(rawData.map(d => d.servico))];
            const pagtos = [...new Set(rawData.map(d => d.pagto))];
            
            populateSelect('filter-ano', anos);
            populateSelect('filter-mes', meses.map(m => ({value: m, label: getMonthName(m)})));
            populateSelect('filter-quinzena', quinzenas);
            populateSelect('filter-dia-semana', diasSemana);
            populateSelect('filter-servico', servicos);
            populateSelect('filter-pagto', pagtos);
        }

        function populateSelect(id, options) {
            const select = document.getElementById(id);
            select.innerHTML = '';
            options.forEach(opt => {
                const option = document.createElement('option');
                if (typeof opt === 'object') {
                    option.value = opt.value;
                    option.textContent = opt.label;
                } else {
                    option.value = opt;
                    option.textContent = opt;
                }
                select.appendChild(option);
            });
        }

        function getMonthName(month) {
            const months = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            return months[month - 1] || month;
        }

        // Apply Filters
        function applyFilters() {
            filteredData = rawData.filter(row => {
                const anos = Array.from(document.getElementById('filter-ano').selectedOptions).map(o => Number(o.value));
                const meses = Array.from(document.getElementById('filter-mes').selectedOptions).map(o => Number(o.value));
                const quinzenas = Array.from(document.getElementById('filter-quinzena').selectedOptions).map(o => o.value);
                const diasSemana = Array.from(document.getElementById('filter-dia-semana').selectedOptions).map(o => o.value);
                const servicos = Array.from(document.getElementById('filter-servico').selectedOptions).map(o => o.value);
                const pagtos = Array.from(document.getElementById('filter-pagto').selectedOptions).map(o => o.value);
                const dataInicio = document.getElementById('filter-data-inicio').value;
                const dataFim = document.getElementById('filter-data-fim').value;
                
                if (anos.length && !anos.includes(row.ano)) return false;
                if (meses.length && !meses.includes(row.mes)) return false;
                if (quinzenas.length && !quinzenas.includes(row.quinzenas)) return false;
                if (diasSemana.length && !diasSemana.includes(row.dia_semana)) return false;
                if (servicos.length && !servicos.includes(row.servico)) return false;
                if (pagtos.length && !pagtos.includes(row.pagto)) return false;
                
                if (dataInicio || dataFim) {
                    const rowDate = new Date(row.ano, row.mes - 1, row.dia);
                    if (dataInicio && rowDate < new Date(dataInicio)) return false;
                    if (dataFim && rowDate > new Date(dataFim)) return false;
                }
                
                return true;
            });
            
            updateDashboard();
        }

        function clearFilters() {
            document.querySelectorAll('select').forEach(s => s.selectedIndex = -1);
            document.getElementById('filter-data-inicio').value = '';
            document.getElementById('filter-data-fim').value = '';
            filteredData = [...rawData];
            updateDashboard();
        }

        // Update Dashboard
        function updateDashboard() {
            updateKPIs();
            createAllCharts();
        }

        // Update KPIs
        function updateKPIs() {
            const data = filteredData;
            const totalReceita = data.reduce((sum, d) => sum + (d.valor || 0), 0);
            const totalClientes = new Set(data.map(d => d.cliente)).size;
            const ticketMedio = totalReceita / data.length;
            const comissaoJean = data.reduce((sum, d) => sum + (d.comissao_jean || 0), 0);
            const comissaoReino = data.reduce((sum, d) => sum + (d.comissao_reino_da_barba || 0), 0);
            const metaMensal = data[0]?.meta_mensal || 0;
            const atingimentoMeta = (totalReceita / metaMensal * 100).toFixed(1);
            
            const kpisHTML = `
                <div class="kpi-card">
                    <div class="kpi-title">Total Receita</div>
                    <div class="kpi-value">${formatCurrency(totalReceita)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Ticket M√©dio</div>
                    <div class="kpi-value">${formatCurrency(ticketMedio)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Total Clientes</div>
                    <div class="kpi-value">${totalClientes}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Atingimento Meta</div>
                    <div class="kpi-value">${atingimentoMeta}%</div>
                    <div class="kpi-change ${atingimentoMeta >= 100 ? 'positive' : 'negative'}">
                        ${atingimentoMeta >= 100 ? '‚úì Meta atingida' : '‚ö† Abaixo da meta'}
                    </div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Comiss√£o Jean</div>
                    <div class="kpi-value">${formatCurrency(comissaoJean)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Comiss√£o Reino</div>
                    <div class="kpi-value">${formatCurrency(comissaoReino)}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Atendimentos</div>
                    <div class="kpi-value">${data.length}</div>
                </div>
                <div class="kpi-card">
                    <div class="kpi-title">Meta Mensal</div>
                    <div class="kpi-value">${formatCurrency(metaMensal)}</div>
                </div>
            `;
            
            document.getElementById('kpis-container').innerHTML = kpisHTML;
        }

        // Create All Charts
        function createAllCharts() {
            // Destroy old charts
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {};
            
            createRevenueGoalChart();
            createGoalGaugeChart();
            createServicesMixChart();
            createTopClientsChart();
            createRevenueDayWeekChart();
            createDailyProductivityChart();
            createServicesHeatmap();
            createPaymentMethodsChart();
            createAvgTicketChart();
            createRevenueFortnightChart();
            createClientFrequencyChart();
            createNewRecurringChart();
            createParetoChart();
            createPaymentEvolutionChart();
            createCommissionsChart();
            createGoalGapChart();
            createSeasonalityChart();
            createYoYChart();
        }

        // Chart 1: Revenue vs Goal
        function createRevenueGoalChart() {
            const monthlyData = groupBy(filteredData, d => `${d.ano}-${String(d.mes).padStart(2, '0')}`);
            const labels = Object.keys(monthlyData).sort();
            const revenues = labels.map(key => {
                return monthlyData[key].reduce((sum, d) => sum + (d.valor || 0), 0);
            });
            const goals = labels.map(key => monthlyData[key][0]?.meta_mensal || 0);
            
            const ctx = document.getElementById('chart-revenue-goal').getContext('2d');
            charts.revenueGoal = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => l.substring(5) + '/' + l.substring(0, 4)),
                    datasets: [
                        {
                            label: 'Faturamento',
                            data: revenues,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true,
                            tension: 0.4
                        },
                        {
                            label: 'Meta',
                            data: goals,
                            borderColor: '#10b981',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: context => context.dataset.label + ': ' + formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 2: Goal Gauge
        function createGoalGaugeChart() {
            const totalReceita = filteredData.reduce((sum, d) => sum + (d.valor || 0), 0);
            const metaMensal = filteredData[0]?.meta_mensal || 1;
            const percentage = Math.min((totalReceita / metaMensal * 100), 100);
            
            const ctx = document.getElementById('chart-goal-gauge').getContext('2d');
            charts.goalGauge = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Atingido', 'Faltante'],
                    datasets: [{
                        data: [percentage, 100 - percentage],
                        backgroundColor: ['#10b981', '#e5e7eb'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    circumference: 180,
                    rotation: 270,
                    cutout: '75%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => context.label + ': ' + context.parsed.toFixed(1) + '%'
                            }
                        }
                    }
                }
            });
        }

        // Chart 3: Services Mix
        function createServicesMixChart() {
            const servicesData = groupBy(filteredData, d => d.servico);
            const labels = Object.keys(servicesData);
            const values = labels.map(key => {
                return servicesData[key].reduce((sum, d) => sum + (d.valor || 0), 0);
            });
            
            const ctx = document.getElementById('chart-services-mix').getContext('2d');
            charts.servicesMix = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => context.label + ': ' + formatCurrency(context.parsed)
                            }
                        }
                    }
                }
            });
        }

        // Chart 4: Top Clients
        function createTopClientsChart() {
            const clientsData = groupBy(filteredData, d => d.cliente);
            const sorted = Object.entries(clientsData)
                .map(([cliente, records]) => ({
                    cliente,
                    valor: records.reduce((sum, d) => sum + (d.valor || 0), 0)
                }))
                .sort((a, b) => b.valor - a.valor)
                .slice(0, 10);
            
            const ctx = document.getElementById('chart-top-clients').getContext('2d');
            charts.topClients = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(d => d.cliente),
                    datasets: [{
                        label: 'Receita',
                        data: sorted.map(d => d.valor),
                        backgroundColor: '#2563eb'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => formatCurrency(context.parsed.x)
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 5: Revenue by Day of Week
        function createRevenueDayWeekChart() {
            const daysOrder = ['segunda', 'ter√ßa', 'quarta', 'quinta', 'sexta', 's√°bado', 'domingo'];
            const daysData = groupBy(filteredData, d => d.dia_semana.toLowerCase());
            const data = daysOrder.map(day => {
                const dayRecords = daysData[day] || [];
                return dayRecords.reduce((sum, d) => sum + (d.valor || 0), 0);
            });
            
            const ctx = document.getElementById('chart-revenue-day-week').getContext('2d');
            charts.revenueDayWeek = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: daysOrder.map(d => d.charAt(0).toUpperCase() + d.slice(1)),
                    datasets: [{
                        label: 'Receita',
                        data: data,
                        backgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 6: Daily Productivity
        function createDailyProductivityChart() {
            const dailyData = groupBy(filteredData, d => `${d.ano}-${String(d.mes).padStart(2, '0')}-${String(d.dia).padStart(2, '0')}`);
            const labels = Object.keys(dailyData).sort().slice(-30); // Last 30 days
            const revenues = labels.map(key => {
                return dailyData[key].reduce((sum, d) => sum + (d.valor || 0), 0);
            });
            
            const ctx = document.getElementById('chart-daily-productivity').getContext('2d');
            charts.dailyProductivity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => l.substring(8) + '/' + l.substring(5, 7)),
                    datasets: [{
                        label: 'Receita Di√°ria',
                        data: revenues,
                        borderColor: '#10b981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 7: Services Heatmap
        function createServicesHeatmap() {
            const daysOrder = ['segunda', 'ter√ßa', 'quarta', 'quinta', 'sexta', 's√°bado', 'domingo'];
            const servicos = [...new Set(filteredData.map(d => d.servico))];
            
            const heatmapData = {};
            servicos.forEach(servico => {
                heatmapData[servico] = {};
                daysOrder.forEach(day => {
                    heatmapData[servico][day] = 0;
                });
            });
            
            filteredData.forEach(d => {
                const day = d.dia_semana.toLowerCase();
                if (heatmapData[d.servico] && heatmapData[d.servico][day] !== undefined) {
                    heatmapData[d.servico][day]++;
                }
            });
            
            const maxValue = Math.max(...Object.values(heatmapData).flatMap(obj => Object.values(obj)));
            
            let html = '<table class="heatmap-table"><thead><tr><th>Servi√ßo</th>';
            daysOrder.forEach(day => {
                html += `<th>${day.charAt(0).toUpperCase() + day.slice(1)}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            servicos.forEach(servico => {
                html += `<tr><td><strong>${servico}</strong></td>`;
                daysOrder.forEach(day => {
                    const value = heatmapData[servico][day];
                    const intensity = maxValue > 0 ? (value / maxValue) : 0;
                    const color = `rgba(37, 99, 235, ${intensity})`;
                    html += `<td style="background: ${color}; color: ${intensity > 0.5 ? 'white' : 'black'}">${value}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            document.getElementById('heatmap-services').innerHTML = html;
        }

        // Chart 8: Payment Methods
        function createPaymentMethodsChart() {
            const paymentData = groupBy(filteredData, d => d.pagto);
            const labels = Object.keys(paymentData);
            const values = labels.map(key => {
                return paymentData[key].reduce((sum, d) => sum + (d.valor || 0), 0);
            });
            
            const ctx = document.getElementById('chart-payment-methods').getContext('2d');
            charts.paymentMethods = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: ['#2563eb', '#10b981', '#f59e0b'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: context => context.label + ': ' + formatCurrency(context.parsed)
                            }
                        }
                    }
                }
            });
        }

        // Chart 9: Average Ticket by Service
        function createAvgTicketChart() {
            const servicesData = groupBy(filteredData, d => d.servico);
            const labels = Object.keys(servicesData);
            const avgTickets = labels.map(key => {
                const records = servicesData[key];
                const total = records.reduce((sum, d) => sum + (d.valor || 0), 0);
                return total / records.length;
            });
            
            const ctx = document.getElementById('chart-avg-ticket').getContext('2d');
            charts.avgTicket = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ticket M√©dio',
                        data: avgTickets,
                        backgroundColor: '#f59e0b'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 10: Revenue by Fortnight
        function createRevenueFortnightChart() {
            const fortnightData = groupBy(filteredData, d => d.quinzenas);
            const labels = Object.keys(fortnightData).sort();
            const revenues = labels.map(key => {
                return fortnightData[key].reduce((sum, d) => sum + (d.valor || 0), 0);
            });
            
            const ctx = document.getElementById('chart-revenue-fortnight').getContext('2d');
            charts.revenueFortnight = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Receita por Quinzena',
                        data: revenues,
                        backgroundColor: '#10b981'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 11: Client Frequency
        function createClientFrequencyChart() {
            const clientCounts = {};
            filteredData.forEach(d => {
                clientCounts[d.cliente] = (clientCounts[d.cliente] || 0) + 1;
            });
            
            const frequencies = Object.values(clientCounts);
            const histogram = {};
            frequencies.forEach(freq => {
                const bucket = freq === 1 ? '1' : freq === 2 ? '2' : freq === 3 ? '3' : freq <= 5 ? '4-5' : '6+';
                histogram[bucket] = (histogram[bucket] || 0) + 1;
            });
            
            const labels = ['1', '2', '3', '4-5', '6+'];
            const data = labels.map(l => histogram[l] || 0);
            
            const ctx = document.getElementById('chart-client-frequency').getContext('2d');
            charts.clientFrequency = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => l + ' visitas'),
                    datasets: [{
                        label: 'N√∫mero de Clientes',
                        data: data,
                        backgroundColor: '#2563eb'
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Chart 12: New vs Recurring Clients
        function createNewRecurringChart() {
            const monthlyData = groupBy(filteredData, d => `${d.ano}-${String(d.mes).padStart(2, '0')}`);
            const labels = Object.keys(monthlyData).sort();
            
            const seenClients = new Set();
            const newClients = [];
            const recurringClients = [];
            
            labels.forEach(month => {
                const monthRecords = monthlyData[month];
                let newCount = 0;
                let recurringCount = 0;
                
                monthRecords.forEach(d => {
                    if (seenClients.has(d.cliente)) {
                        recurringCount++;
                    } else {
                        newCount++;
                        seenClients.add(d.cliente);
                    }
                });
                
                newClients.push(newCount);
                recurringClients.push(recurringCount);
            });
            
            const ctx = document.getElementById('chart-new-recurring').getContext('2d');
            charts.newRecurring = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => l.substring(5) + '/' + l.substring(0, 4)),
                    datasets: [
                        {
                            label: 'Novos',
                            data: newClients,
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            fill: true
                        },
                        {
                            label: 'Recorrentes',
                            data: recurringClients,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Chart 13: Pareto (ABC Curve)
        function createParetoChart() {
            const clientsData = groupBy(filteredData, d => d.cliente);
            const sorted = Object.entries(clientsData)
                .map(([cliente, records]) => ({
                    cliente,
                    valor: records.reduce((sum, d) => sum + (d.valor || 0), 0)
                }))
                .sort((a, b) => b.valor - a.valor);
            
            const totalRevenue = sorted.reduce((sum, d) => sum + d.valor, 0);
            let cumulative = 0;
            const cumulativePercentages = sorted.map(d => {
                cumulative += d.valor;
                return (cumulative / totalRevenue * 100).toFixed(1);
            });
            
            const top20 = sorted.slice(0, Math.ceil(sorted.length * 0.2));
            
            const ctx = document.getElementById('chart-pareto').getContext('2d');
            charts.pareto = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top20.map((d, i) => `Cliente ${i + 1}`),
                    datasets: [
                        {
                            type: 'bar',
                            label: 'Receita',
                            data: top20.map(d => d.valor),
                            backgroundColor: '#2563eb',
                            yAxisID: 'y'
                        },
                        {
                            type: 'line',
                            label: '% Acumulado',
                            data: cumulativePercentages.slice(0, top20.length),
                            borderColor: '#ef4444',
                            backgroundColor: 'transparent',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        },
                        y1: {
                            type: 'linear',
                            position: 'right',
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: value => value + '%'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Chart 14: Payment Evolution
        function createPaymentEvolutionChart() {
            const monthlyData = groupBy(filteredData, d => `${d.ano}-${String(d.mes).padStart(2, '0')}`);
            const labels = Object.keys(monthlyData).sort();
            const paymentTypes = [...new Set(filteredData.map(d => d.pagto))];
            
            const datasets = paymentTypes.map((type, index) => {
                const colors = ['#2563eb', '#10b981', '#f59e0b'];
                return {
                    label: type,
                    data: labels.map(month => {
                        const monthRecords = monthlyData[month].filter(d => d.pagto === type);
                        return monthRecords.reduce((sum, d) => sum + (d.valor || 0), 0);
                    }),
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '33',
                    fill: true
                };
            });
            
            const ctx = document.getElementById('chart-payment-evolution').getContext('2d');
            charts.paymentEvolution = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => l.substring(5) + '/' + l.substring(0, 4)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: context => context.dataset.label + ': ' + formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            stacked: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 15: Commissions Distribution
        function createCommissionsChart() {
            const monthlyData = groupBy(filteredData, d => `${d.ano}-${String(d.mes).padStart(2, '0')}`);
            const labels = Object.keys(monthlyData).sort();
            
            const jeanData = labels.map(month => {
                return monthlyData[month].reduce((sum, d) => sum + (d.comissao_jean || 0), 0);
            });
            
            const reinoData = labels.map(month => {
                return monthlyData[month].reduce((sum, d) => sum + (d.comissao_reino_da_barba || 0), 0);
            });
            
            const ctx = document.getElementById('chart-commissions').getContext('2d');
            charts.commissions = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels.map(l => l.substring(5) + '/' + l.substring(0, 4)),
                    datasets: [
                        {
                            label: 'Jean',
                            data: jeanData,
                            backgroundColor: '#2563eb'
                        },
                        {
                            label: 'Reino da Barba',
                            data: reinoData,
                            backgroundColor: '#10b981'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: context => context.dataset.label + ': ' + formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: true
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 16: Goal Gap (Waterfall)
        function createGoalGapChart() {
            const totalReceita = filteredData.reduce((sum, d) => sum + (d.valor || 0), 0);
            const metaMensal = filteredData[0]?.meta_mensal || 0;
            const gap = totalReceita - metaMensal;
            
            const ctx = document.getElementById('chart-goal-gap').getContext('2d');
            charts.goalGap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Meta', 'Realizado', 'Gap'],
                    datasets: [{
                        data: [metaMensal, totalReceita, gap],
                        backgroundColor: ['#64748b', '#2563eb', gap >= 0 ? '#10b981' : '#ef4444']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: context => formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 17: Seasonality with Moving Average
        function createSeasonalityChart() {
            const dailyData = groupBy(filteredData, d => `${d.ano}-${String(d.mes).padStart(2, '0')}-${String(d.dia).padStart(2, '0')}`);
            const labels = Object.keys(dailyData).sort().slice(-60); // Last 60 days
            const revenues = labels.map(key => {
                return dailyData[key].reduce((sum, d) => sum + (d.valor || 0), 0);
            });
            
            // Calculate 7-day moving average
            const movingAvg = revenues.map((_, index, arr) => {
                const start = Math.max(0, index - 6);
                const window = arr.slice(start, index + 1);
                return window.reduce((sum, val) => sum + val, 0) / window.length;
            });
            
            const ctx = document.getElementById('chart-seasonality').getContext('2d');
            charts.seasonality = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(l => l.substring(8) + '/' + l.substring(5, 7)),
                    datasets: [
                        {
                            label: 'Receita Di√°ria',
                            data: revenues,
                            borderColor: '#cbd5e1',
                            backgroundColor: 'transparent',
                            borderWidth: 1
                        },
                        {
                            label: 'M√©dia M√≥vel (7 dias)',
                            data: movingAvg,
                            borderColor: '#2563eb',
                            backgroundColor: 'transparent',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: context => context.dataset.label + ': ' + formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Chart 18: Year over Year Comparison
        function createYoYChart() {
            const years = [...new Set(filteredData.map(d => d.ano))].sort();
            const months = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];
            
            const datasets = years.map((year, index) => {
                const colors = ['#2563eb', '#10b981', '#f59e0b', '#ef4444'];
                return {
                    label: year.toString(),
                    data: months.map(month => {
                        const monthRecords = filteredData.filter(d => d.ano === year && d.mes === month);
                        return monthRecords.reduce((sum, d) => sum + (d.valor || 0), 0);
                    }),
                    backgroundColor: colors[index % colors.length]
                };
            });
            
            const ctx = document.getElementById('chart-yoy').getContext('2d');
            charts.yoy = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months.map(m => getMonthName(m)),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: context => context.dataset.label + ': ' + formatCurrency(context.parsed.y)
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: value => formatCurrency(value)
                            }
                        }
                    }
                }
            });
        }

        // Utility Functions
        function groupBy(array, keyFn) {
            return array.reduce((result, item) => {
                const key = keyFn(item);
                if (!result[key]) result[key] = [];
                result[key].push(item);
                return result;
            }, {});
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value || 0);
        }
    </script>
</body>
</html>
